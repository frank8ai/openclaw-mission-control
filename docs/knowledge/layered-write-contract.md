# 分层写入契约（Layered Write Contract）

“分层写入契约”是一种把一次写入（尤其是给 LLM / autopilot / 工作流引擎的写入）拆成几个层级，并对每一层规定：
- 写什么
- 什么时候写
- 写到哪里
- 失败时怎么降级
- 允许的长度/格式

核心目的：在保证可用性的前提下，把“上下文变大、成本上升、漂移变多、难以回滚”的风险压到可控范围。

## 1. 什么叫“分层”
常见的分层方式是：从“不可或缺、结构化、稳定”的信息，到“可选、冗余、易变”的信息逐层追加。

一个典型层级（由高到低优先级）：
1) L0: 任务元数据/约束（ID、目标、输出格式、不可做的事）
2) L1: 关键上下文（能直接影响决策的事实、依赖、现状）
3) L2: 证据片段（日志/代码片段的短引用，指向来源而不是整段搬运）
4) L3: 补充背景（历史讨论、长链路推导、旁枝信息）
5) L4: 可回溯链接/工件（文件路径、URL、run id）

## 2. 什么叫“契约”
“契约”指的是：对每一层的写入制定规则，让系统可验证。
常见契约字段：
- required/optional（必须/可选）
- maxChars/maxItems（长度/条数上限）
- schema（结构：JSON 字段、段落顺序）
- freshness（时效：多久过期/何时刷新）
- sourceOfTruth（真源：以 Linear、repo、run log 还是人工说明为准）
- fallback（拿不到这一层时怎么降级）

## 3. 价值在哪里
1) 控制成本：先写 L0/L1，信息足够就停止，避免把 L3/L4 全塞进 prompt。
2) 降低漂移：模型最容易被“冗长背景/历史噪声”带偏；分层能把噪声隔离在低层。
3) 可调试：当输出不稳定时，可以定位是“缺了哪一层”还是“哪一层污染了决策”。
4) 可回滚：只要保持 L0/L1 稳定，低层变化对行为的影响可控；必要时可一键砍掉 L3/L4。
5) 可扩展：随着系统增长，新增信息只需要挂到合适层级，不必整体改 prompt 或协议。

## 4. 在 mission-control / autopilot 里的落地例子
以 `docs/sop/autopilot-prompt-contract.md` 为例，它其实就是一个分层写入契约：
- L0: Instruction + SOP + Output Contract（强结构，必须）
- L1: Issue Metadata + Core Context（目标/约束/风险的短摘要）
- L2: Tail summaries（只保留最后 3 条，避免 log 注入）
- L4: 链接/路径（引用工单与工件，避免原文堆叠）
同时还定义了长度上限和“不要注入 raw logs”等规则。

## 5. 使用建议（最小可用）
- 先定义 L0/L1：没有它们就不要跑自动化。
- 为 L2/L3 设硬上限（chars/items），并且尽量用“引用”替代“粘贴”。
- 把契约写成可检查的文档/代码（例如在构造 prompt 时做 length 检测与截断）。

